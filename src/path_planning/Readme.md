# f9r\_roi\_path ë…¸ë“œ ì„¤ëª…ì„œ

ì´ ë¬¸ì„œëŠ” `/f9r_roi_path.cpp`ì˜ ë™ì‘ì„ **í•œëˆˆì—** ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì •ë¦¬í•œ ë§ˆí¬ë‹¤ìš´ ê°€ì´ë“œì…ë‹ˆë‹¤. ROS 2 Humble + C++ ê¸°ì¤€ì…ë‹ˆë‹¤.

---

## ê°œìš”

* ì…ë ¥: `/csv_path` (`nav_msgs/Path`) â€“ **CSV í”„ë ˆì„**ì—ì„œ ì €ì¥ëœ ì „ì²´ ê¸°ì¤€ ê²½ë¡œ
* (ì˜µì…˜) ì…ë ¥: `/f9r/fix` (`sensor_msgs/NavSatFix`) â€“ íƒ€ì´ë°/ìƒíƒœìš©
* TF: `target_frame`(ì°¨ëŸ‰ ì›ì ) â†’ `csv_frame`(ê²½ë¡œ í”„ë ˆì„) ë³€í™˜ìœ¼ë¡œ **ì°¨ëŸ‰ì˜ í˜„ì¬ ìœ„ì¹˜** ì‚°ì¶œ
* ì¶œë ¥:

  * `/f9r_roi_path` (`visualization_msgs/Marker`, LINE\_STRIP) â€“ ROI êµ¬ê°„
  * `/f9r_roi_end`  (`visualization_msgs/Marker`, SPHERE) â€“ ROI ëì 

**í•µì‹¬ ëª©í‘œ**

1. **ì¸ë±ìŠ¤ ë‹¨ì¡° ë¹„ê°ì†Œ**: ì‹œì‘ ì¸ë±ìŠ¤ëŠ” ì ˆëŒ€ ë’¤ë¡œ ê°€ì§€ ì•ŠìŒ
2. **ì „ë°© íƒìƒ‰ë§Œ**: ì—­ë°©í–¥/ì—­ì£¼í–‰ ì„ íƒ ê¸ˆì§€
3. **ì í”„ ë°©ì§€ ì œì•½**: **ì§ì „ í”„ë ˆì„ì˜ ROI ìœ„ì— ìˆì—ˆë˜ ì ë“¤** ì¤‘ì—ì„œë§Œ ë‹¤ìŒ ì‹œì‘ì  ì„ íƒ

---

## í”„ë ˆì„ & í† í”½

* `target_frame` (ê¸°ë³¸ `f9r`): ì°¨ëŸ‰ì˜ í˜„ì¬ ìœ„ì¹˜ í”„ë ˆì„ (ë³´í†µ `base_link`/`base_footprint`)
* `csv_frame` (ê¸°ë³¸ `csv`): `/csv_path`ê°€ ì •ì˜ëœ ê³ ì • ì§€ë„ í”„ë ˆì„(ëŒ€ê°œ UTM\[m])

ë…¸ë“œëŠ” `TF`ë¥¼ ì´ìš©í•´ `target_frame` ì›ì (0,0,0)ì„ `csv_frame`ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ \*\*ì°¨ëŸ‰ì˜ í˜„ì¬ (x,y)\*\*ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

---

## íŒŒë¼ë¯¸í„°

| ì´ë¦„                   |     ê¸°ë³¸ê°’ | ë‹¨ìœ„  | ì˜ë¯¸ / ì‚¬ìš©ì²˜              | ë³€ê²½ ì‹œ ì˜í–¥                          |
| -------------------- | ------: | --- | --------------------- | -------------------------------- |
| `target_frame`       | `"f9r"` | -   | ì°¨ëŸ‰ ì›ì  í”„ë ˆì„ëª…            | TF ë³€í™˜ ì‹¤íŒ¨ ì‹œ ROI ê°±ì‹  ë¶ˆê°€             |
| `csv_frame`          | `"csv"` | -   | ê²½ë¡œê°€ ì •ì˜ëœ í”„ë ˆì„ëª…          | RViz í‘œì‹œ/ê±°ë¦¬ ê³„ì‚° ê¸°ì¤€                 |
| `timer_frequency`    |  `20.0` | Hz  | ROI ê°±ì‹  ì£¼ê¸°             | ë†’ì„ìˆ˜ë¡ ë°˜ì‘ì„±â†‘/ë¶€í•˜â†‘                    |
| `roi_length_m`       |   `7.0` | m   | ê±°ë¦¬ ê¸°ë°˜ ROI ê¸¸ì´          | `use_points_length=false`ì¼ ë•Œë§Œ ìœ íš¨ |
| `use_points_length`  | `false` | -   | ROI ê¸¸ì´ ë‹¨ìœ„ë¥¼ í¬ì¸íŠ¸ ê°œìˆ˜ë¡œ ì „í™˜ | trueë©´ `roi_length_points` ì‚¬ìš©     |
| `roi_length_points`  |    `50` | pts | í¬ì¸íŠ¸ ê°œìˆ˜ ê¸°ë°˜ ROI ê¸¸ì´      | ì  ê°„ê²©ì´ ì¼ì •í•  ë•Œ í¸ë¦¬                   |
| `search_span_points` |  `2000` | pts | **ì´ˆê¸° 1íšŒ** ì „ë°© íƒìƒ‰ í­     | ì´ˆê¸° ë½ì˜¨ ì‹¤íŒ¨/ì†ë„ì— ì˜í–¥                  |
| `hysteresis_k`       |     `0` | idx | ì‹œì‘ì  ê°±ì‹  íˆìŠ¤í…Œë¦¬ì‹œìŠ¤         | ë¯¸ì„¸ í”ë“¤ë¦¼ ì–µì œ, ë°˜ì‘ì„± ì €í•˜ ê°€ëŠ¥             |
| `line_width`         |   `0.2` | m   | ROI ì„  ë‘ê»˜ (RViz)       | ì‹œê°í™”ë§Œ ì˜í–¥                          |
| `end_marker_size`    |   `0.7` | m   | ëì  êµ¬ì²´ í¬ê¸° (RViz)       | ì‹œê°í™”ë§Œ ì˜í–¥                          |

ì¶”ì²œê°’ ì˜ˆì‹œëŠ” ë§ˆì§€ë§‰ ì„¹ì…˜ ì°¸ê³ .

---

## ì•Œê³ ë¦¬ì¦˜ íë¦„

1. **ê²½ë¡œ ìˆ˜ì‹ ** (`/csv_path`)

   * `nav_msgs/Path`ë¥¼ ë‚´ë¶€ ë²¡í„° `csv_pts_`(x,y)ë¡œ ì €ì¥
   * ê²½ë¡œê°€ ì‹¤ì œë¡œ ë°”ë€Œì—ˆì„ ë•Œë§Œ ì¸ë±ìŠ¤ ìƒí•œ í´ë¨í”„(ë¦¬ì…‹ ê¸ˆì§€)

2. **í˜„ì¬ ìœ„ì¹˜ ê³„ì‚°**

   * `target_frame` ì›ì  â†’ `csv_frame`ìœ¼ë¡œ TF ë³€í™˜ â†’ (xf, yf)

3. **ì‹œì‘ì  í›„ë³´ êµ¬ê°„ ì„¤ì •**

   * ì²« í¼ë¸”ë¦¬ì‹œ ì „: `last_start_idx_`ë¶€í„° `search_span_points`ë§Œí¼ **ì „ë°©**
   * ì´í›„ ëª¨ë“  í”„ë ˆì„: **ì§ì „ ROI** `[last_start_idx_, last_end_idx_]` **ë‚´ë¶€ë¡œ ì œí•œ**

     * ğŸ‘‰ ë‹¤ë¥¸ ê²½ë¡œ/ì¸ì ‘ ë£¨í”„ ë“±ìœ¼ë¡œ â€œì í”„â€ ë¶ˆê°€

4. **í›„ë³´ êµ¬ê°„ì—ì„œ ìµœê·¼ì ‘ì  íƒìƒ‰**

   * (xf, yf)ì™€ ê° í›„ë³´ì  ê°„ **ê±°ë¦¬ ì œê³±** ìµœì†Ÿê°’ ì¸ë±ìŠ¤ `nearest_idx`

5. **ë‹¨ì¡°ì„± + íˆìŠ¤í…Œë¦¬ì‹œìŠ¤**

   * `start_idx = max(nearest_idx, last_start_idx_)`
   * `hysteresis_k > 0`ì´ë©´ `nearest_idx < last_start_idx_ + k`ì¼ ë•Œ **ìœ ì§€**

6. **ROI ê¸¸ì´ í™•ì •**

   * ê±°ë¦¬ ê¸°ë°˜: ì¸ì ‘ ì  ê°„ ê±°ë¦¬ ëˆ„ì  â‰¥ `roi_length_m`ê°€ ë˜ëŠ” ì¸ë±ìŠ¤ê¹Œì§€
   * ê°œìˆ˜ ê¸°ë°˜: `start_idx + roi_length_points`

7. **ì¶œë ¥ í¼ë¸”ë¦¬ì‹œ**

   * `/f9r_roi_path`: LINE\_STRIP (ë…¹ìƒ‰)
   * `/f9r_roi_end`: SPHERE (ë¹¨ê°•)
   * ì´í›„ `last_start_idx_ = start_idx`, `last_end_idx_ = end_idx`, `published_once_ = true`

---

## â€œì§ì „ ROI ìœ„ì—ì„œë§Œ ì‹œì‘ì  ì„ ì •â€ ì œì•½

* **ì´ˆê¸° 1íšŒ**ë§Œ ë„“ê²Œ ì „ë°© íƒìƒ‰í•´ ì˜¬ë°”ë¥¸ íŠ¸ë™ì— **ë½ì˜¨**
* ì´í›„ì—ëŠ” ì‹œì‘ì  í›„ë³´ë¥¼ **ì§ì „ í”„ë ˆì„ì—ì„œ ì‹¤ì œë¡œ ê·¸ë ¸ë˜ ROI êµ¬ê°„**ìœ¼ë¡œ ì œí•œ
* ê²°ê³¼: ë¶„ê¸°/êµì°¨ë¡œì—ì„œ ë‹¤ë¥¸ ë¼ì¸ìœ¼ë¡œ **ì í”„**í•˜ëŠ” í˜„ìƒ ë°©ì§€

---

## ì¸ë±ìŠ¤ ë‹¨ì¡°ì„± ë³´ì¥

* `start_idx = max(nearest_idx, last_start_idx_)`
* ì–´ë–¤ ìƒí™©ì—ì„œë„ ì‹œì‘ ì¸ë±ìŠ¤ëŠ” **ê°ì†Œí•˜ì§€ ì•ŠìŒ**
* ê²½ë¡œ ì¬ìˆ˜ì‹  ì‹œì—ë„ **ë¦¬ì…‹ ê¸ˆì§€**(ê²½ë¡œ ë³€ê²½ ì‹œ ìƒí•œ ë³´ì •ë§Œ)

---

## QoS (Reliability / Durability)

* êµ¬ë… `/csv_path`: `QoS(1).reliable().transient_local()`
* ë°œí–‰ `/f9r_roi_path`, `/f9r_roi_end`: ë™ì¼í•˜ê²Œ `reliable().transient_local()`
* ì¥ì : RViz/ë…¸ë“œ ì¬ì—°ê²° ì‹œ **ë§ˆì§€ë§‰ ë©”ì‹œì§€**ë¥¼ ê³§ë°”ë¡œ ì¬ì „ë‹¬
* ì£¼ì˜: Transient Localì€ ìƒíƒœ ê´€ë¦¬(ì¸ë±ìŠ¤ ë¦¬ì…‹ ê¸ˆì§€) ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì§€ ì•ŠìŒ

---

## ìŠ¤ë ˆë“œ ì•ˆì „

* `pathCallback`(êµ¬ë…)ê³¼ `timerCallback`(íƒ€ì´ë¨¸)ì´ ê³µìœ  ìƒíƒœë¥¼ ë§Œì§€ë¯€ë¡œ `std::mutex` ì‚¬ìš©
* ì½œë°± ë‚´ë¶€ì—ì„œëŠ” **ë½ ìµœì†Œí™”**ë¥¼ ìœ„í•´ **ë¡œì»¬ ë³µì‚¬ë³¸**ìœ¼ë¡œ ê³„ì‚° â†’ ê²°ê³¼ë§Œ ë°˜ì˜

---

## ì‹¤íŒ¨/ê²½ê³„ ì¼€ì´ìŠ¤

* **TF ë³€í™˜ ì‹¤íŒ¨**: ë¡œê·¸ ê²½ê³  + í”„ë ˆì„ ìŠ¤í‚µ

  * `target_frame`ì™€ `csv_frame` ì´ë¦„/TF íŠ¸ë¦¬ í™•ì¸
* **ë¹ˆ ê²½ë¡œ**: `/csv_path` ë¹„ì—ˆì„ ë•Œ ROI í¼ë¸”ë¦¬ì‹œ ì¤‘ë‹¨
* **ê²½ë¡œ ë³€ê²½**: í¬ê¸°/í‘œë³¸ì  ë¹„êµë¡œ **ë³€ê²½ ê°ì§€**, ì¸ë±ìŠ¤ ìƒí•œë§Œ í´ë¨í”„

---

## RViz ì‹œê°í™”

* `/f9r_roi_path`: LINE\_STRIP, êµµê¸° `line_width` (m), ë…¹ìƒ‰
* `/f9r_roi_end`: SPHERE, í¬ê¸° `end_marker_size` (m), ë¶‰ì€ ì 
* í‘œì‹œ í”„ë ˆì„: `csv_frame` (ì¢Œí‘œ ë§ì¶°ë³´ê¸° ì‰¬ì›€)

---

## ì„¤ì • ì˜ˆì‹œ (YAML)

```yaml
f9r_roi_path:
  ros__parameters:
    target_frame: "base_link"
    csv_frame: "csv"
    timer_frequency: 20.0
    use_points_length: false
    roi_length_m: 20.0       # ê±°ë¦¬ ê¸°ë°˜
    # use_points_length: true
    # roi_length_points: 50   # ì  ê°„ê²©â‰ˆ1më¼ë©´ â‰ˆ50m
    search_span_points: 3000
    hysteresis_k: 2
    line_width: 0.2
    end_marker_size: 0.7
```

---

## íŠœë‹ ê°€ì´ë“œ

* **ì´ˆê¸° ë½ì˜¨ì´ ëŠ¦ë‹¤** â†’ `search_span_points` â†‘
* **ì‹œì‘ì ì´ ìì˜í•˜ê²Œ í”ë“¤ë¦°ë‹¤** â†’ `hysteresis_k` 1\~3
* **ROI ë„ˆë¬´ ì§§/ê¸¸ë‹¤** â†’ `roi_length_m` ë˜ëŠ” `roi_length_points` ì¡°ì •
* **ê³ ì†ì—ì„œ ë°˜ì‘ì´ ë‘”í•˜ë‹¤** â†’ `timer_frequency` â†‘ (CPU ì—¬ìœ  ê³ ë ¤)

---

âœ¦ pure_pursuit.cpp íŒŒì¼ì—ì„œ /throttle_from_planning í† í”½ì˜ ê°’ì€ í˜„ì¬ ê³„ì‚°ëœ ì¡°í–¥ê°(steering angle)ì— ê¸°ë°˜í•˜ì—¬ ê²°ì •ë©ë‹ˆë‹¤. í•µì‹¬ ë¡œì§ì€ "ì¡°í–¥ê°ì´ í´ìˆ˜ë¡ 
  ì†ë„ë¥¼ ì¤„ì´ëŠ” ê²ƒ"ì…ë‹ˆë‹¤.

  ê³„ì‚° ê³¼ì •ì€ onTimer í•¨ìˆ˜ ë‚´ì˜ 7) ìŠ¤ë¡œí‹€ ê³„ì‚° ì„¹ì…˜ì— ìˆìœ¼ë©°, ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ê³„ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

   1. ì¡°í–¥ê° ì •ê·œí™” (Normalization)
       * ë¨¼ì €, ê³„ì‚°ëœ ìµœì¢… ì¡°í–¥ê°(steer_out)ì˜ ì ˆëŒ“ê°’ì„ ì¡°í–¥ê° ì œí•œ(limit)ìœ¼ë¡œ ë‚˜ëˆ„ì–´ 0ê³¼ 1 ì‚¬ì´ì˜ ê°’ìœ¼ë¡œ ì •ê·œí™”í•©ë‹ˆë‹¤.
       * ì´ ê°’(abs_steer_normalized)ì€ 0ì¼ ë•Œ ì§ì§„, 1ì¼ ë•Œ ìµœëŒ€ ì¡°í–¥ ìƒíƒœë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

   1     // 7) ìŠ¤ë¡œí‹€ ê³„ì‚° 
   2     const double abs_steer_normalized = std::abs(steer_out) / limit; // ì •ê·œí™”ëœ ì¡°í–¥ê° í¬ê¸° (0~1)

   2. ê¸°ë³¸ ìŠ¤ë¡œí‹€ ê°’ ê³„ì‚°
       * ì •ê·œí™”ëœ ì¡°í–¥ê°ì„ ì´ìš©í•´ max_throttle_ê³¼ min_throttle_ ì‚¬ì´ì—ì„œ ìŠ¤ë¡œí‹€ ê°’ì„ ì„ í˜•ì ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
       * ì¡°í–¥ê°ì´ 0(ì§ì§„)ì´ë©´ throttle_valueëŠ” max_throttle_ì´ ë©ë‹ˆë‹¤.
       * ì¡°í–¥ê°ì´ ìµœëŒ€ì¹˜(limit)ì´ë©´ throttle_valueëŠ” min_throttle_ì´ ë©ë‹ˆë‹¤.

   1     // ì¡°í–¥ê°ì´ í´ìˆ˜ë¡ ìŠ¤ë¡œí‹€ì„ ì¤„ì„
   2     double throttle_value = max_throttle_ - abs_steer_normalized * (max_throttle_ - min_throttle_);
   3     throttle_value = clamp(throttle_value, min_throttle_, max_throttle_);

   3. EMA í•„í„° ì ìš© (Smoothing)
       * ê³„ì‚°ëœ ìŠ¤ë¡œí‹€ ê°’ì´ ê¸‰ê²©í•˜ê²Œ ë³€í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì§€ìˆ˜ì´ë™í‰ê· (Exponential Moving Average, EMA) í•„í„°ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
       * throttle_ema_alpha_ íŒŒë¼ë¯¸í„°ê°€ ì´ í•„í„°ì˜ ê°•ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤. (1ì— ê°€ê¹Œìš¸ìˆ˜ë¡ í˜„ì¬ ê°’ì— ê°€ì¤‘, 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì´ì „ ê°’ì— ê°€ì¤‘)

   1     // ìŠ¤ë¡œí‹€ ê°’ EMA í•„í„° ì ìš©
   2     if (!throttle_filt_.has_value()) {
   3       throttle_filt_ = throttle_value;
   4     } else {
   5       throttle_filt_ = throttle_ema_alpha_ * throttle_value + (1.0 - throttle_ema_alpha_) * throttle_filt_.value();
   6     }

   4. ìµœì¢… ê°’ ë°œí–‰ (Publish)
       * í•„í„°ë§ëœ ìµœì¢… ìŠ¤ë¡œí‹€ ê°’ì„ /throttle_from_planning í† í”½ìœ¼ë¡œ ë°œí–‰í•©ë‹ˆë‹¤.
   1     publishThrottle(throttle_filt_.value());

  ìš”ì•½:
  /throttle_from_planning ê°’ì€ ì½”ë„ˆë¥¼ ëŒ ë•Œ(ì¡°í–¥ê°ì´ ì»¤ì§ˆ ë•Œ) ê°ì†í•˜ê³ , ì§ì§„í•  ë•Œ(ì¡°í–¥ê°ì´ ì‘ì•„ì§ˆ ë•Œ) ê°€ì†í•˜ë„ë¡ ì¡°í–¥ê°ì— ë°˜ë¹„ë¡€í•˜ì—¬ ê³„ì‚°ëœ í›„, ë¶€ë“œëŸ¬ìš´
  ì£¼í–‰ì„ ìœ„í•´ EMA í•„í„°ë¥¼ ê±°ì³ ìµœì¢…ì ìœ¼ë¡œ ë°œí–‰ë©ë‹ˆë‹¤. ê´€ë ¨ íŒŒë¼ë¯¸í„°ëŠ” min_throttle, max_throttle, throttle_ema_alpha ì…ë‹ˆë‹¤.
